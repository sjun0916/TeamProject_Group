<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="Board">
    <sql id="includeBoard">
        WHERE BRDDELETEFLAG='N'
         <if test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
              <foreach item="item" index="index" collection="searchTypeArr" separator=" OR " open="AND (" close=")">
                     ${item} LIKE '%'||#{searchKeyword}||'%'
              </foreach>
        </if>               
    </sql>

    <select id="selectBoardCount" resultType="Integer" parameterType="com.group.common.SearchVO">
        SELECT COUNT(*)
          FROM BOARD
         <include refid="includeBoard"/>
    </select> 
    
    <select id="selectBoardList" resultType="com.group.vo.BoardVO" parameterType="com.group.common.SearchVO">
        SELECT BOARDNUM, TITLE, DEPARTNAME, WRITER, TO_CHAR(REGDATE,'yyyy-mm-dd') REGDATE, HIT
             , (SELECT COUNT(*) FROM BOARDFILE WHERE BOARDNUM=DS.BOARDNUM) FILECNT
             , (SELECT COUNT(*) FROM BOARDREPLY WHERE BOARDNUM=DS.BOARDNUM AND REDELETEFLAG='N') REPLYCNT
          FROM (
            SELECT BOARDNUM, TITLE, DEPARTNAME, WRITER, REGDATE, HIT
              , ROW_NUMBER() OVER(ORDER BY BOARDNUM DESC) BOARDNUM_SEQ
          FROM BOARD
          <include refid="includeBoard"/>
          ) DS
         WHERE BOARDNUM_SEQ BETWEEN ${rowStart} AND ${rowEnd}
         ORDER BY BOARDNUM DESC
    </select> 
    
    <insert id="insertBoard" parameterType="com.group.vo.BoardVO" >
    	<selectKey resultType="String" keyProperty="boardnum" order="BEFORE">
            SELECT BOARDNUM_SEQ.NEXTVAL FROM DUAL
        </selectKey> 
        INSERT INTO BOARD(BOARDNUM, TITLE, DEPARTNAME, WRITER, CONTENT, REGDATE, HIT, BRDDELETEFLAG)
        VALUES (#{boardnum}, #{title}, #{departname}, #{writer}, #{content}, SYSDATE, 0, 'N' )
    </insert>
    
    <update id="updateBoard" parameterType="com.group.vo.BoardVO">
        UPDATE BOARD
           SET TITLE=#{title}
             , WRITER=#{writer}
             , CONTENT=#{content} 
         WHERE BRDDELETEFLAG='N'
           AND BOARDNUM=#{boardnum}
    </update> 
        
    <select id="selectBoardOne" parameterType="String" resultType="com.group.vo.BoardVO">
        SELECT BOARDNUM, TITLE, WRITER, CONTENT, TO_CHAR(REGDATE,'yyyy-mm-dd') REGDATE
          FROM BOARD
         WHERE BRDDELETEFLAG='N'
           AND BOARDNUM=#{boardnum}
    </select> 

    <update id="updateBoardRead" parameterType="String">
        UPDATE BOARD
           SET HIT = HIT + 1 
         WHERE BOARDNUM=#{boardnum}
    </update> 

    <delete id="deleteBoardOne" parameterType="String">
        UPDATE BOARD
           SET BRDDELETEFLAG='Y' 
         WHERE BOARDNUM=#{boardnum}
    </delete> 

    <!-- =============================================================================== -->
    <select id="selectBoardFileList" resultType="com.group.common.FileVO" parameterType="String">
        SELECT FILENUM, FILENAME, REALNAME, FILESIZE
          FROM BOARDFILE
         WHERE BOARDNUM=#{boardnum}
         ORDER BY FILENUM DESC 
    </select> 

    <insert id="insertBoardFile" parameterType="com.group.common.FileVO" >
        INSERT INTO BOARDFILE (BOARDNUM, FILENUM, FILENAME, REALNAME, FILESIZE)
        VALUES (#{parentPK}, FILENUM_SEQ.NEXTVAL, #{filename}, #{realname}, #{filesize})
    </insert>
    
    <delete id="deleteBoardFile" parameterType="hashmap"> 
        DELETE 
          FROM BOARDFILE
         WHERE FILENUM IN (
              <foreach item="item" index="index" collection="filenum" separator=",">
                     ${item}
              </foreach>  
        )             
    </delete> 

    <!-- =============================================================================== -->
    <select id="selectBoardReplyList" resultType="com.group.vo.BoardReplyVO" parameterType="String">
        SELECT BOARDNUM, RENUM, REWRITER, REDELETEFLAG, REMEMO, REDATE 
          FROM BOARDREPLY
         WHERE BOARDNUM=#{boardnum} AND REDELETEFLAG='N'
         ORDER BY RENUM
    </select>
        
    <insert id="insertBoardReply" parameterType="com.group.vo.BoardReplyVO" >
        <selectKey resultType="String" keyProperty="renum" order="BEFORE">
            SELECT NVL(MAX(RENUM),0)+1 FROM BOARDREPLY
        </selectKey>
            
        INSERT INTO BOARDREPLY(BOARDNUM, RENUM, REWRITER, REDELETEFLAG, REMEMO, REDATE)
        VALUES (#{boardnum}, #{renum}, #{rewriter}, 'N', #{rememo}, SYSDATE)
    </insert>

    <update id="deleteBoardReply" parameterType="String"> 
        UPDATE BOARDREPLY
           SET REDELETEFLAG='Y' 
         WHERE RENUM=#{renum}       
    </update> 

    <update id="updateBoardReply" parameterType="com.group.vo.BoardReplyVO">
        UPDATE BOARDREPLY
           SET REMEMO=#{rememo} 
         WHERE RENUM=#{renum}
    </update> 
         
</mapper>

